---
title: "System Suitability and QC"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{System Suitability and QC}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## Overview

System Suitability Testing (SST) ensures that the chromatographic system is performing adequately before, during, and after sample analysis. This vignette covers:

1. Key SST parameters for SEC
2. Using the QC functions
3. Comprehensive system suitability testing
4. Regulatory requirements

## Setup

```{r setup}
library(measure)
library(measure.sec)
library(dplyr)
library(ggplot2)
```

## Key SST Parameters

### Resolution (Rs)

Resolution measures the separation between adjacent peaks:

$$R_s = \frac{2(t_2 - t_1)}{W_{b1} + W_{b2}}$$

```{r resolution}
# Calculate resolution between two peaks
Rs <- measure_sec_resolution(
  retention_1 = 8.2,   # Dimer peak
  retention_2 = 9.5,   # Monomer peak
  width_1 = 0.4,
  width_2 = 0.5,
  method = "usp"
)

cat("Resolution:", round(Rs, 2), "\n")
```

**Interpretation:**

| Rs Value | Separation | Quality |
|----------|------------|---------|
| < 1.0 | Poor overlap | Unacceptable |
| 1.0 | ~94% separated | Marginal |
| 1.5 | Baseline separation | Acceptable |
| > 2.0 | Complete separation | Excellent |

### Plate Count (N)

Theoretical plate count measures column efficiency:

$$N = 5.54 \left(\frac{t_R}{W_{0.5h}}\right)^2$$

```{r plate-count}
# Calculate plate count for a peak
N <- measure_sec_plate_count(
  retention = 9.5,
  width = 0.25,
  width_type = "half_height"
)

cat("Theoretical plates:", round(N), "\n")

# With dead time for effective plates
N_eff <- measure_sec_plate_count(
  retention = 9.5,
  width = 0.25,
  dead_time = 3.0
)

cat("Effective plates:", round(N_eff), "\n")
```

**Typical SEC Performance:**

| Column Type | Plates/meter |
|------------|--------------|
| Analytical SEC | 10,000-40,000 |
| Prep SEC | 5,000-15,000 |
| UHPLC SEC | 50,000+ |

### Peak Asymmetry

Asymmetry indicates deviation from Gaussian peak shape:

```{r asymmetry}
# Calculate tailing factor (USP method)
Tf <- measure_sec_asymmetry(
  leading = 0.12,   # Leading half-width at 5% height
  tailing = 0.15,   # Tailing half-width at 5% height
  method = "usp"
)

cat("Tailing factor:", round(Tf, 2), "\n")

# EP asymmetry factor (at 10% height)
As <- measure_sec_asymmetry(
  leading = 0.10,
  tailing = 0.12,
  method = "ep"
)

cat("Asymmetry factor:", round(As, 2), "\n")
```

**Interpretation:**

| Value | Shape | Interpretation |
|-------|-------|----------------|
| 0.8-1.0 | Slight fronting | Acceptable |
| 1.0 | Symmetric | Ideal |
| 1.0-1.2 | Slight tailing | Acceptable |
| > 1.5 | Significant tailing | Investigate |
| > 2.0 | Severe tailing | Problem |

### Mass Recovery

Recovery verifies that all injected sample is detected:

```{r recovery}
# Calculate percent recovery
recovery <- measure_sec_recovery(
  detected_mass = 0.195,
  injected_mass = 0.200
)

cat("Recovery:", round(recovery, 1), "%\n")
```

**Acceptance Criteria:**

| Recovery | Status | Action |
|----------|--------|--------|
| 95-105% | Pass | None |
| 90-95% or 105-110% | Marginal | Investigate |
| < 90% | Fail | Identify cause |

## Comprehensive SST

### Using measure_sec_suitability()

Run a complete SST evaluation:

```{r sst}
# Define peak data from integration
peaks <- data.frame(
  name = c("aggregate", "dimer", "monomer", "fragment"),
  retention = c(7.2, 8.5, 9.8, 11.5),
  width = c(0.30, 0.28, 0.32, 0.38),
  area = c(2.1, 5.3, 89.2, 3.4)
)

# Run system suitability test
sst <- measure_sec_suitability(
  peaks = peaks,
  reference_peaks = c("dimer", "monomer"),  # Critical pair for resolution
  column_length = 30  # cm
)

print(sst)
```

### Custom Criteria

Specify custom acceptance criteria:

```{r custom-criteria}
# Stricter criteria for validated method
strict_criteria <- list(
  resolution_min = 2.0,       # Higher resolution requirement
  plate_count_min = 10000,    # Higher efficiency
  tailing_min = 0.9,
  tailing_max = 1.3,
  recovery_min = 97,
  recovery_max = 103,
  retention_rsd_max = 0.5,
  area_rsd_max = 1.0
)

sst_strict <- measure_sec_suitability(
  peaks = peaks,
  reference_peaks = c("dimer", "monomer"),
  criteria = strict_criteria
)

print(sst_strict)
```

### Adding Replicate Data

For precision assessment:

```{r replicates}
# Replicate injections
peaks_reps <- data.frame(
  name = rep(c("dimer", "monomer"), each = 6),
  replicate = rep(1:6, 2),
  retention = c(
    8.52, 8.51, 8.53, 8.50, 8.52, 8.51,  # Dimer
    9.80, 9.81, 9.79, 9.82, 9.80, 9.81   # Monomer
  ),
  width = c(
    0.28, 0.27, 0.28, 0.28, 0.29, 0.28,
    0.32, 0.31, 0.32, 0.31, 0.32, 0.32
  ),
  area = c(
    5.2, 5.4, 5.3, 5.1, 5.3, 5.2,
    89.5, 88.9, 89.2, 89.8, 89.1, 89.4
  )
)

sst_reps <- measure_sec_suitability(
  peaks = peaks_reps,
  reference_peaks = c("dimer", "monomer")
)

summary(sst_reps)
```

## Column Performance Tracking

### Monitoring Over Time

```{r tracking, fig.width=8, fig.height=5}
# Simulated column tracking data (22 weeks)
dates <- seq(as.Date("2024-01-01"), as.Date("2024-06-01"), by = "week")
n_weeks <- length(dates)

# Create declining performance metrics
column_log <- tibble(
  date = dates,
  plates = seq(25000, 19500, length.out = n_weeks),
  resolution = seq(2.5, 1.95, length.out = n_weeks)
)

ggplot(column_log, aes(date)) +
  geom_line(aes(y = plates / 10000), color = "#2E86AB", linewidth = 1) +
  geom_line(aes(y = resolution), color = "#A23B72", linewidth = 1) +
  geom_hline(yintercept = 1.5, linetype = "dashed", color = "#A23B72") +
  geom_hline(yintercept = 1.0, linetype = "dashed", color = "#2E86AB") +
  annotate("text", x = as.Date("2024-01-15"), y = 1.55, label = "Rs limit", color = "#A23B72") +
  annotate("text", x = as.Date("2024-01-15"), y = 1.05, label = "N limit (×10⁴)", color = "#2E86AB") +
  scale_y_continuous(
    name = "Resolution",
    sec.axis = sec_axis(~. * 10000, name = "Theoretical Plates")
  ) +
  labs(
    x = "Date",
    title = "Column Performance Tracking",
    subtitle = "Resolution (pink) and plate count (blue) over time"
  ) +
  theme_minimal()
```

### Calculating Column Lifetime

```{r lifetime}
# When performance drops below limit
min_plates <- 10000
min_resolution <- 1.5

# Find when limits are crossed
plates_ok <- column_log$plates > min_plates
resolution_ok <- column_log$resolution > min_resolution

# Column lifetime estimate
column_lifetime_weeks <- min(which(!plates_ok | !resolution_ok))

cat("Estimated column lifetime:", column_lifetime_weeks, "weeks\n")
cat("Last acceptable date:", format(column_log$date[column_lifetime_weeks - 1]), "\n")
```

## Regulatory Framework

### USP <621> Requirements

| Parameter | Requirement |
|-----------|-------------|
| Resolution | Rs ≥ 2.0 (unless otherwise specified) |
| Tailing | T ≤ 2.0 |
| Plate count | As specified in monograph |
| RSD (replicate injections) | ≤ 2.0% for areas |

### ICH Guidelines

**ICH Q2(R1) Validation:**
- Precision (RSD of replicate injections)
- Accuracy (recovery studies)
- Specificity (resolution from interfering peaks)

**ICH Q6B Specifications:**
- Aggregate content limits
- Purity specifications

### FDA Guidance

- SST should be performed before sample analysis
- Reference standard should be analyzed with each batch
- Control charts recommended for trending

## Best Practices

### SST Frequency

| Situation | SST Level |
|-----------|----------|
| Beginning of sequence | Full SST |
| Every 10-20 injections | Bracketing standard |
| End of sequence | System check |
| After mobile phase change | Full SST |
| After column change | Full SST + qualification |

### Documentation

1. **Record all SST results** in batch records
2. **Establish control limits** from historical data
3. **Investigate OOS results** before proceeding
4. **Trend SST data** over time

### Troubleshooting

| Symptom | Possible Cause | Action |
|---------|----------------|--------|
| Low resolution | Column degradation | Replace column |
| Peak tailing | Sample overload | Reduce injection |
| Low plates | Column void | Check frit/replace |
| Poor recovery | Adsorption | Change mobile phase |
| High RSD | Injection variability | Check autosampler |

## Session Info

```{r session-info}
sessionInfo()
```
