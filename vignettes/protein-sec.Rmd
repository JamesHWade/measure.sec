---
title: "Protein SEC Analysis"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Protein SEC Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## Overview
Size Exclusion Chromatography (SEC) is a critical analytical technique for biopharmaceutical characterization. It separates proteins based on hydrodynamic size, enabling quantification of:

- **High Molecular Weight Species (HMWS)**: Aggregates, dimers, oligomers
- **Monomer**: The intended product
- **Low Molecular Weight Species (LMWS)**: Fragments, degradation products

This vignette covers:

1. Protein SEC basics
2. Aggregate quantitation workflows
3. Detailed oligomer analysis
4. Regulatory considerations

## Setup

```{r setup}
library(measure)
library(measure.sec)
library(recipes)
library(dplyr)
library(ggplot2)
```

## Protein SEC Principles

### Elution Order

In SEC, proteins elute in order of decreasing size:

```{r elution-concept, echo = FALSE, fig.width=7, fig.height=4}
# Simulate protein SEC chromatogram
time <- seq(5, 18, by = 0.05)

# HMW aggregate
hmw <- 0.03 * dnorm(time, mean = 7, sd = 0.3)
# Dimer
dimer <- 0.08 * dnorm(time, mean = 8.5, sd = 0.35)
# Monomer (main peak)
monomer <- 0.85 * dnorm(time, mean = 10, sd = 0.4)
# Fragment
fragment <- 0.04 * dnorm(time, mean = 13, sd = 0.5)

chrom_data <- tibble(
  time = time,
  signal = hmw + dimer + monomer + fragment
)

peak_labels <- tibble(
  time = c(7, 8.5, 10, 13),
  signal = c(0.035, 0.09, 0.9, 0.05),
  label = c("HMW\nAggregate", "Dimer", "Monomer", "Fragment")
)

ggplot(chrom_data, aes(time, signal)) +
  geom_line(linewidth = 1, color = "#2E86AB") +
  geom_area(alpha = 0.2, fill = "#2E86AB") +
  geom_text(data = peak_labels, aes(label = label), vjust = -0.5, size = 3.5) +
  annotate(
    "segment",
    x = 9, xend = 11, y = 0.88, yend = 0.88,
    arrow = arrow(ends = "both", length = unit(0.1, "inches"))
  ) +
  annotate("text", x = 10, y = 0.92, label = "Monomer region") +
  labs(
    x = "Retention Time (min)",
    y = "UV Absorbance (280 nm)",
    title = "Typical Protein SEC Chromatogram",
    subtitle = "mAb with aggregates and fragments"
  ) +
  theme_minimal()
```

### Detection

Protein SEC typically uses UV detection at 280 nm (tryptophan/tyrosine absorbance).

## Basic Aggregate Quantitation

### Using step_sec_aggregates()

For simple HMWS/monomer/LMWS quantitation:

```{r aggregates-basic}
# Load protein SEC data - mAb samples with reference and stressed conditions
data(sec_protein, package = "measure.sec")

# Start with the reference sample
protein_ref <- sec_protein |>
  filter(sample_id == "mAb-Reference")

# Aggregate quantitation using tallest peak detection
rec_agg <- recipe(
  uv_280_signal + elution_time ~ sample_id,
  data = protein_ref
) |>
  update_role(sample_id, new_role = "id") |>
  # Convert UV 280 nm signal to measure format
  step_measure_input_long(
    uv_280_signal,
    location = vars(elution_time),
    col_name = "uv"
  ) |>
  # Baseline correction
  step_sec_baseline(measures = "uv") |>
  # Aggregate quantitation - auto-detect monomer peak
  step_sec_aggregates(
    measures = "uv",
    method = "tallest"
  )

prepped_agg <- prep(rec_agg)
result_agg <- bake(prepped_agg, new_data = NULL)

# View aggregate results
result_agg |>
  select(sample_id, purity_hmws, purity_monomer, purity_lmws)
```

### Manual Peak Boundaries

For precise control over integration limits:

```{r aggregates-manual, eval = FALSE}
# When you know the exact monomer elution window
step_sec_aggregates(
  measures = "uv",
  monomer_start = 14.5,  # Monomer peak start (min)
  monomer_end = 17.5,    # Monomer peak end (min)
  method = "manual"
)
```

## Complete Protein Workflow

### Using step_sec_protein()

The `step_sec_protein()` function provides a streamlined workflow combining baseline correction, aggregate analysis, and optional oligomer detection:

```{r protein-workflow}
# Analyze all mAb samples with the protein step
rec_protein <- recipe(
  uv_280_signal + elution_time ~ sample_id,
  data = sec_protein
) |>
  update_role(sample_id, new_role = "id") |>
  step_measure_input_long(
    uv_280_signal,
    location = vars(elution_time),
    col_name = "uv"
  ) |>
  step_sec_protein(
    measures = "uv",
    type = "native",
    monomer_mw = 150000,        # mAb ~150 kDa
    baseline_method = "linear"
  )

prepped_protein <- prep(rec_protein)
result_protein <- bake(prepped_protein, new_data = NULL)

# View results for all samples
result_protein |>
  select(sample_id, starts_with("protein_"))
```

### Output Columns

The `step_sec_protein()` step creates:

| Column | Description |
|--------|-------------|
| `protein_hmws_pct` | % high molecular weight species |
| `protein_monomer_pct` | % main peak (monomer) |
| `protein_lmws_pct` | % low molecular weight species |
| `protein_main_start` | Start of monomer region |
| `protein_main_end` | End of monomer region |

With `include_oligomer = TRUE`:

| Column | Description |
|--------|-------------|
| `protein_monomer_oligo_pct` | % monomer from oligomer analysis |
| `protein_dimer_pct` | % dimer |
| `protein_trimer_pct` | % trimer |
| `protein_hmw_oligo_pct` | % higher oligomers |
| `protein_lmw_oligo_pct` | % fragments |
| `protein_species_count` | Number of detected species |

## Native vs Denaturing SEC

### Native SEC

Preserves non-covalent interactions:

```{r native, eval = FALSE}
step_sec_protein(
  type = "native",
  monomer_mw = 150000
)
```

Use for:
- Detecting reversible aggregates
- Oligomer state assessment
- Native quaternary structure

### Denaturing SEC (SDS-SEC)

Disrupts non-covalent interactions:

```{r denaturing, eval = FALSE}
step_sec_protein(
  type = "denaturing",
  monomer_mw = 150000
)
```

Use for:
- Covalent aggregate detection
- Clipped/truncated species
- Heavy/light chain analysis

## Detailed Oligomer Analysis

### Using step_sec_oligomer()

For more control over oligomer detection:

```{r oligomer, eval = FALSE}
# Detailed oligomer analysis with explicit control
rec_oligo <- recipe(
  uv_280_signal + elution_time ~ sample_id,
  data = sec_protein
) |>
  update_role(sample_id, new_role = "id") |>
  step_measure_input_long(
    uv_280_signal,
    location = vars(elution_time),
    col_name = "uv"
  ) |>
  step_sec_baseline(measures = "uv") |>
  step_sec_oligomer(
    measures = "uv",
    monomer_mw = 150000,
    mw_tolerance = 0.15,     # 15% MW tolerance for species assignment
    min_area_pct = 0.1       # Minimum 0.1% to report
  )
```

### Species Assignment

The oligomer step identifies species based on expected MW:

| Species | Expected MW | Example (mAb) |
|---------|-------------|---------------|
| Fragment | < 0.7 × monomer | < 105 kDa |
| Monomer | 1.0 × monomer | 150 kDa |
| Dimer | 2.0 × monomer | 300 kDa |
| Trimer | 3.0 × monomer | 450 kDa |
| Higher oligomer | > 3 × monomer | > 450 kDa |

## Regulatory Considerations

### ICH Guidelines

- **ICH Q6B**: Specifications for biotechnology products
  - Aggregate content is a critical quality attribute
  - Typical specification: HMWS < 5%

- **ICH Q5E**: Comparability of biotechnology products
  - Aggregate profiles should be comparable

### USP Guidelines

- **USP <129>**: Analytical procedures for proteins
- **USP <1032>**: Design and development of biological assays

### Typical Specifications

| Parameter | Typical Limit | Notes |
|-----------|--------------|-------|
| HMWS | < 5% | May be tighter for high-dose products |
| Monomer | > 95% | Primary quality indicator |
| LMWS | < 2% | Product-specific |
| Dimer | Report | Not always specified separately |

## Best Practices

### Sample Preparation

1. **Filter samples** through 0.22 μm before injection
2. **Minimize time** between prep and analysis
3. **Use appropriate buffer** (match formulation buffer)
4. **Control temperature** during autosampler storage

### Method Parameters

1. **Column selection**: Appropriate exclusion limit for aggregates
2. **Mobile phase**: Typically PBS or phosphate buffer
3. **Flow rate**: 0.5-1.0 mL/min
4. **Injection volume**: 10-100 μL (depending on concentration)
5. **Detection**: 280 nm (standard) or 214 nm (higher sensitivity)

### Integration

1. **Consistent baseline** selection across samples
2. **Same integration limits** for all samples in a study
3. **Report detection limit** for minor species

## Example: Comparing Stressed Samples

The `sec_protein` dataset includes samples under various stress conditions, simulating a stability study:

```{r stability-comparison}
# Analyze all samples including stressed conditions
result_protein |>
  select(sample_id, protein_hmws_pct, protein_monomer_pct, protein_lmws_pct) |>
  arrange(desc(protein_hmws_pct))
```

```{r stability-plot, fig.width=7, fig.height=4}
# Compare aggregate content across conditions
library(tidyr)

plot_data <- result_protein |>
  select(sample_id, protein_hmws_pct, protein_monomer_pct, protein_lmws_pct) |>
  pivot_longer(
    cols = starts_with("protein_"),
    names_to = "species",
    values_to = "percent"
  ) |>
  mutate(
    species = case_when(
      species == "protein_hmws_pct" ~ "HMWS",
      species == "protein_monomer_pct" ~ "Monomer",
      species == "protein_lmws_pct" ~ "LMWS"
    ),
    species = factor(species, levels = c("HMWS", "Monomer", "LMWS"))
  )

# Focus on non-monomer species for clarity
plot_data |>
  filter(species != "Monomer") |>
  ggplot(aes(x = sample_id, y = percent, fill = species)) +
  geom_col(position = "dodge") +
  geom_hline(yintercept = 5, linetype = "dashed", color = "red") +
  annotate("text", x = 1, y = 5.5, label = "Typical spec: < 5%", color = "red", hjust = 0) +
  scale_fill_manual(values = c("HMWS" = "#E8751A", "LMWS" = "#2E86AB")) +
  labs(
    x = NULL,
    y = "% of Total",
    fill = "Species",
    title = "Aggregate and Fragment Content by Sample",
    subtitle = "Comparing reference vs stressed mAb samples"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

## See Also

- [Getting Started](getting-started.html) - Basic SEC workflow and concepts
- [System Suitability](system-suitability.html) - QC metrics for biopharm compliance
- [Multi-Detector SEC](triple-detection.html) - MALS for absolute MW determination
- [Exporting Results](exporting-results.html) - Summary tables and report generation

## Session Info

```{r session-info}
sessionInfo()
```
