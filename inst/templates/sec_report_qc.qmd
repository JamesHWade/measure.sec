---
title: "`r params$title`"
author: "`r params$author`"
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    toc-depth: 2
    code-fold: true
    embed-resources: true
    theme: flatly
  pdf:
    toc: true
    toc-depth: 2
  docx:
    toc: true
    toc-depth: 2
params:
  title: "SEC System Suitability Report"
  author: ""
  data: NULL
  sample_id: NULL
  include_plots: true
  specs: NULL
execute:
  echo: false
  warning: false
  message: false
---

```{r}
#| label: setup
#| include: false

library(measure.sec)
library(ggplot2)

# Extract data from params
data <- params$data
sample_id <- params$sample_id
specs <- params$specs

# Default specifications if not provided
if (is.null(specs)) {
  specs <- list(
    plate_count_min = 10000,
    asymmetry_min = 0.8,
    asymmetry_max = 1.5,
    resolution_min = 1.5,
    recovery_min = 95,
    recovery_max = 105
  )
}
```

# System Suitability Summary

This report evaluates the SEC system performance against acceptance criteria.

```{r}
#| label: overall-status
#| results: asis

# Determine overall pass/fail status
overall_pass <- TRUE
status_items <- list()

cat("::: {.callout-note}\n")
cat("## Test Date: ", format(Sys.Date(), "%B %d, %Y"), "\n")
cat(":::\n\n")
```

# QC Metrics

## Plate Count (Column Efficiency)

```{r}
#| label: plate-count
#| results: asis

tryCatch(
  {
    # Check if plate count is pre-calculated in data
    if ("plate_count" %in% names(data)) {
      plate_count <- data$plate_count[1]
      status <- if (plate_count >= specs$plate_count_min) "PASS" else "FAIL"
      status_color <- if (status == "PASS") "green" else "red"

      cat(sprintf("**Result:** %s plates\n\n", format(round(plate_count), big.mark = ",")))
      cat(sprintf("**Specification:** >= %s plates\n\n", format(specs$plate_count_min, big.mark = ",")))
      cat(sprintf("**Status:** [%s]{style='color: %s; font-weight: bold;'}\n\n", status, status_color))
    } else {
      cat("**Status:** [NOT EVALUATED]{style='color: orange; font-weight: bold;'}\n\n")
      cat("*Plate count requires pre-calculated peak parameters.*\n\n")
      cat("To calculate plate count, use `measure_sec_plate_count()` with:\n\n")
      cat("- `retention`: Peak retention time\n")
      cat("- `width`: Peak width at half height\n")
    }
  },
  error = function(e) {
    cat("**Plate count calculation failed.**\n\n")
    cat("```\n")
    cat("Error: ", conditionMessage(e), "\n")
    cat("```\n\n")
    cat("**Status:** [NOT EVALUATED]{style='color: orange; font-weight: bold;'}\n")
  }
)
```

## Peak Asymmetry

```{r}
#| label: asymmetry
#| results: asis

tryCatch(
  {
    # Check if asymmetry is pre-calculated in data
    if ("asymmetry" %in% names(data)) {
      asymmetry <- data$asymmetry[1]
      in_range <- asymmetry >= specs$asymmetry_min && asymmetry <= specs$asymmetry_max
      status <- if (in_range) "PASS" else "FAIL"
      status_color <- if (status == "PASS") "green" else "red"

      cat(sprintf("**Result:** %.3f\n\n", asymmetry))
      cat(sprintf("**Specification:** %.1f - %.1f\n\n", specs$asymmetry_min, specs$asymmetry_max))
      cat(sprintf("**Status:** [%s]{style='color: %s; font-weight: bold;'}\n\n", status, status_color))
    } else {
      cat("**Status:** [NOT EVALUATED]{style='color: orange; font-weight: bold;'}\n\n")
      cat("*Asymmetry requires pre-calculated peak parameters.*\n\n")
      cat("To calculate asymmetry, use `measure_sec_asymmetry()` with:\n\n")
      cat("- `leading`: Peak width from leading edge to apex\n")
      cat("- `tailing`: Peak width from apex to trailing edge\n")
    }
  },
  error = function(e) {
    cat("**Asymmetry calculation failed.**\n\n")
    cat("```\n")
    cat("Error: ", conditionMessage(e), "\n")
    cat("```\n\n")
    cat("**Status:** [NOT EVALUATED]{style='color: orange; font-weight: bold;'}\n")
  }
)
```

## Resolution

```{r}
#| label: resolution
#| results: asis

tryCatch(
  {
    # Check if resolution is pre-calculated in data
    if ("resolution" %in% names(data)) {
      resolution <- data$resolution[1]
      status <- if (resolution >= specs$resolution_min) "PASS" else "FAIL"
      status_color <- if (status == "PASS") "green" else "red"

      cat(sprintf("**Result:** %.2f\n\n", resolution))
      cat(sprintf("**Specification:** >= %.1f\n\n", specs$resolution_min))
      cat(sprintf("**Status:** [%s]{style='color: %s; font-weight: bold;'}\n\n", status, status_color))
    } else {
      cat("**Status:** [NOT EVALUATED]{style='color: orange; font-weight: bold;'}\n\n")
      cat("*Resolution requires pre-calculated peak parameters for two adjacent peaks.*\n\n")
      cat("To calculate resolution, use `measure_sec_resolution()` with:\n\n")
      cat("- `retention_1`, `retention_2`: Peak retention times\n")
      cat("- `width_1`, `width_2`: Peak widths\n")
    }
  },
  error = function(e) {
    cat("**Resolution calculation failed.**\n\n")
    cat("```\n")
    cat("Error: ", conditionMessage(e), "\n")
    cat("```\n\n")
    cat("**Status:** [NOT EVALUATED]{style='color: orange; font-weight: bold;'}\n")
  }
)
```

# Chromatogram Review

```{r}
#| label: qc-chromatogram
#| fig-width: 10
#| fig-height: 6
#| fig-cap: "System suitability chromatogram for visual inspection."

if (params$include_plots) {
  tryCatch(
    {
      p <- plot_sec_chromatogram(data, sample_id = sample_id)
      print(p + theme_minimal())
    },
    error = function(e) {
      cat("**Chromatogram plot not available.**\n\n")
      cat("```\n")
      cat("Error: ", conditionMessage(e), "\n")
      cat("```\n\n")
      cat("*Check that data contains valid measure columns with detector signals.*\n")
    }
  )
}
```

# Calibration Verification

```{r}
#| label: calibration
#| fig-width: 10
#| fig-height: 6
#| fig-cap: "Calibration curve showing molecular weight vs. retention time relationship."

if (params$include_plots) {
  tryCatch(
    {
      p <- plot_sec_calibration(data, sample_id = sample_id)
      print(p + theme_minimal())
    },
    error = function(e) {
      cat("**Calibration plot not available.**\n\n")
      cat("```\n")
      cat("Error: ", conditionMessage(e), "\n")
      cat("```\n\n")
      cat("*Ensure calibration has been applied with step_sec_conventional_cal().*\n")
    }
  )
}
```

# Summary

## Overall System Status

```{r}
#| label: overall-summary
#| results: asis

cat("::: {.callout-important}\n")
cat("## System Suitability\n\n")
cat("Review all QC metrics above to determine overall system status.\n\n")
cat("All tests must pass for the system to be considered suitable for analysis.\n")
cat(":::\n")
```

## Acceptance Criteria

| Parameter | Specification |
|-----------|--------------|
| Plate Count | >= `r format(specs$plate_count_min, big.mark = ",")` |
| Asymmetry | `r specs$asymmetry_min` - `r specs$asymmetry_max` |
| Resolution | >= `r specs$resolution_min` |
| Recovery | `r specs$recovery_min`% - `r specs$recovery_max`% |

---
*QC Report generated with measure.sec v`r packageVersion("measure.sec")`*
